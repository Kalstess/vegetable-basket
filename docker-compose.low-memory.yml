version: '3.9'

# 菜篮子系统部署配置
# 经过验证的稳定版本，适用于 2GB 内存服务器
# 修改记录：
# 1. 移除了 MySQL 8.0 不支持的 query-cache-size 参数
# 2. 优化了内存配置，避免 OOM
# 3. 添加了健康检查和启动依赖
# 4. 修正了 SQL 文件导入方式

services:
  db:
    image: mysql:8.0
    container_name: cailanzi-mysql
    restart: unless-stopped  # 改为 unless-stopped，避免无限重启
    environment:
      MYSQL_ROOT_PASSWORD: 111111        # 生产环境请务必修改！
      MYSQL_DATABASE: cailanzi
      TZ: Asia/Shanghai
      MYSQL_INITDB_SKIP_TZINFO: 1        # 跳过时区表加载，减少启动内存
    # MySQL 内存优化配置
    command: [
      "--character-set-server=utf8mb4",
      "--collation-server=utf8mb4_unicode_ci",
      "--default-authentication-plugin=mysql_native_password",
      "--innodb-buffer-pool-size=256M",
      "--max-connections=50",
      "--table-open-cache=512",
      "--thread-cache-size=8",
      # 注意：MySQL 8.0 已移除查询缓存，不要使用 query-cache-size
      "--tmp-table-size=16M",
      "--max-heap-table-size=16M",
      "--key-buffer-size=8M",
      "--sort-buffer-size=2M",
      "--read-buffer-size=1M",
      "--read-rnd-buffer-size=1M",
      "--join-buffer-size=1M",
      "--thread-stack=256K",
      "--performance_schema=OFF",        # 关闭性能模式节省内存
      "--skip-log-bin"                   # 跳过二进制日志，节省磁盘和内存
    ]
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    ports:
      - "3306:3306"   # 生产环境建议改为：127.0.0.1:3306:3306（只本地访问）
    volumes:
      # 注意：SQL 文件将在初始化时自动导入
      # 如果导入失败，可以注释掉下面这行，手动导入
      - ./docs/cailanzi_localhost-2025_12_17_19_51_30-dump.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p111111"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cailanzi-backend
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/cailanzi?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 111111
      # JVM 内存优化参数
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication"
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 512M
    depends_on:
      db:
        condition: service_healthy  # 等待数据库健康后再启动
    ports:
      - "8080:8080"
    # 健康检查（需要应用提供 /actuator/health 或类似端点）
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: cailanzi-frontend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    depends_on:
      backend:
        condition: service_started
    ports:
      - "80:80"
    # Nginx 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  db-data:
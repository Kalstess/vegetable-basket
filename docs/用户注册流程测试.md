# 用户注册流程测试指南

本文档详细说明系统中所有用户身份的注册流程和测试方法。

## 一、用户角色概览

| 角色 | 注册方式 | 是否需要审批 | 创建者 |
|------|---------|------------|--------|
| **ADMIN** | 手动创建（数据库/后台） | 否 | 系统初始化或现有管理员 |
| **BUSINESS_COMMISSION** | 后台创建 | 否 | ADMIN |
| **COMPANY_ADMIN** | 企业自助注册 | 是（商务委审批） | 企业自行注册 |
| **COMPANY_USER** | 后台创建 | 否 | COMPANY_ADMIN 或 ADMIN |
| **DRIVER** | 后台创建 | 否 | COMPANY_ADMIN 或 ADMIN |

---

## 二、测试前准备

### 2.1 确保系统已启动

1. **后端服务**：确保 Spring Boot 应用运行在 `http://localhost:8080`
2. **前端服务**：确保 Vue 应用运行在 `http://localhost:5173`（或配置的端口）
3. **数据库**：确保 MySQL 数据库已连接并可访问

### 2.2 初始化系统管理员（必需）

系统需要一个初始的 ADMIN 账号才能进行后续测试。有两种方式：

#### 方式一：通过数据库直接插入（推荐用于首次测试）

```sql
-- 使用 BCrypt 加密密码 "123123" 的哈希值（rounds=10）
-- 注意：实际使用时需要生成新的 BCrypt 哈希
INSERT INTO users (username, password, nickname, role, is_active, created_at, updated_at)
VALUES ('admin', '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy', '系统管理员', 'ADMIN', 1, NOW(), NOW());
```

**或者使用在线 BCrypt 生成器**：
- 访问：https://bcrypt-generator.com/
- 输入密码：`123123`
- 复制生成的哈希值（以 `$2a$10$` 开头）
- 替换上面的 SQL 中的 password 值

#### 方式二：通过现有管理员创建（如果已有 ADMIN）

如果系统中已有 ADMIN 账号，可以直接登录后台创建新的 ADMIN。

---

## 三、各角色注册流程测试

### 3.1 系统管理员（ADMIN）注册测试

#### 测试步骤：

1. **使用初始 ADMIN 登录**
   - 访问：`http://localhost:5173/login`
   - 用户名：`admin`
   - 密码：`123123`（或你设置的初始密码）

2. **创建新的 ADMIN**
   - 登录后，点击左侧菜单"用户管理"
   - 点击"新增用户"按钮
   - 填写表单：
     ```
     用户名：admin2
     密码：123456
     昵称：管理员2
     邮箱：admin2@example.com
     电话：13800138000
     角色：管理员
     状态：启用
     ```
   - 点击"确定"保存

3. **验证**
   - 退出当前账号
   - 使用新创建的 `admin2` 账号登录
   - 确认可以正常登录并访问所有功能

#### 预期结果：
- ✅ 可以成功创建 ADMIN 账号
- ✅ 新 ADMIN 可以登录系统
- ✅ 新 ADMIN 拥有所有管理权限

---

### 3.2 商务委用户（BUSINESS_COMMISSION）注册测试

#### 测试步骤：

1. **使用 ADMIN 登录**
   - 访问登录页，使用 ADMIN 账号登录

2. **创建商务委用户**
   - 进入"用户管理"页面
   - 点击"新增用户"
   - 填写表单：
     ```
     用户名：business_commission1
     密码：123456
     昵称：商务委用户1
     邮箱：business@example.com
     电话：13900139000
     角色：商务委用户
     状态：启用
     ```
   - 点击"确定"保存

3. **验证商务委用户权限**
   - 退出 ADMIN 账号
   - 使用 `business_commission1` 登录
   - 验证可以：
     - ✅ 查看仪表盘（全市数据）
     - ✅ 查看所有企业列表
     - ✅ 审批企业注册（通过/驳回）
     - ✅ 查看运营分析
     - ❌ 不能创建/删除企业（只能审批）
     - ❌ 不能访问"用户管理"（仅 ADMIN 可见）

#### 预期结果：
- ✅ 商务委用户创建成功
- ✅ 可以登录系统
- ✅ 拥有审批权限和数据查看权限
- ✅ 权限受限正确（不能管理用户和企业）

---

### 3.3 企业管理员（COMPANY_ADMIN）注册测试

这是最复杂的注册流程，包含**企业自助注册**和**商务委审批**两个步骤。

#### 步骤一：企业自助注册

1. **访问注册页面**
   - 访问：`http://localhost:5173/login`
   - 点击"企业自助注册"链接
   - 或直接访问：`http://localhost:5173/company-register`

2. **填写企业信息**
   ```
   企业名称：测试企业A
   企业地址：北京市朝阳区测试路123号
   法定代表人：张三
   法人电话：13800138001
   货运证联系人：李四
   联系人电话：13800138002
   企业性质：民营
   经营范围：蔬菜、水果、肉类配送
   ```

3. **填写企业管理员账号信息**
   ```
   管理员用户名：company_admin_a
   管理员密码：123456
   管理员姓名：王五
   管理员电话：13800138003
   管理员邮箱：admin_a@test.com
   ```

4. **提交注册**
   - 点击"提交注册申请"
   - 系统提示："提交成功，待商务委审核"
   - 自动跳转回登录页

5. **验证注册状态（此时不能登录）**
   - 尝试使用 `company_admin_a` 登录
   - **预期结果**：登录失败，提示"用户已被禁用"或"用户名或密码错误"
   - 这是因为企业状态为 `PENDING`，管理员账号被禁用

#### 步骤二：商务委审批

1. **商务委用户登录**
   - 使用之前创建的 `business_commission1` 账号登录

2. **进入企业管理页面**
   - 点击左侧菜单"企业管理"
   - 在状态筛选中选择"待审核"
   - 应该能看到"测试企业A"（状态为"待审核"）

3. **审批通过**
   - 找到"测试企业A"这一行
   - 点击"审批通过"按钮
   - 在弹出对话框中输入审批备注（可选）：`审核通过，企业资质齐全`
   - 点击"确定"

4. **验证审批结果**
   - 企业状态变为"已通过"
   - 审批备注显示在表格中
   - 审批时间已记录

5. **企业管理员登录验证**
   - 退出商务委账号
   - 使用 `company_admin_a` / `123456` 登录
   - **预期结果**：✅ 可以成功登录
   - 验证可以：
     - ✅ 查看本企业信息
     - ✅ 访问"企业内部用户"菜单
     - ✅ 创建本企业的普通用户和司机用户
     - ❌ 不能看到其他企业的数据

#### 测试审批驳回流程（可选）

1. **再次注册一个企业**
   - 重复步骤一，创建"测试企业B"，管理员账号 `company_admin_b`

2. **商务委驳回**
   - 商务委用户登录
   - 找到"测试企业B"
   - 点击"驳回"按钮
   - 输入驳回原因：`企业信息不完整，请补充材料`
   - 点击"确定"

3. **验证驳回结果**
   - 企业状态变为"已驳回"
   - 审批备注显示驳回原因
   - 尝试使用 `company_admin_b` 登录
   - **预期结果**：❌ 仍然无法登录（账号保持禁用状态）

#### 预期结果：
- ✅ 企业可以成功提交注册申请
- ✅ 企业状态为 `PENDING`，管理员账号被禁用
- ✅ 商务委可以查看待审核企业列表
- ✅ 商务委可以审批通过/驳回企业
- ✅ 审批通过后，企业管理员账号自动启用，可以登录
- ✅ 审批驳回后，企业管理员账号保持禁用状态

---

### 3.4 企业普通用户（COMPANY_USER）注册测试

#### 测试步骤：

1. **企业管理员登录**
   - 使用之前创建的 `company_admin_a` 账号登录

2. **进入企业内部用户管理**
   - 点击左侧菜单"企业内部用户"
   - 应该只看到本企业的用户（目前只有企业管理员自己）

3. **创建企业普通用户**
   - 点击"新增用户"按钮
   - 填写表单：
     ```
     用户名：company_user1
     密码：123456
     昵称：企业普通用户1
     邮箱：user1@test.com
     电话：13800138004
     角色：企业普通用户
     状态：启用
     ```
   - **注意**：不需要选择"关联企业"（自动绑定当前企业）
   - 点击"确定"保存

4. **验证用户创建**
   - 在用户列表中可以看到新创建的用户
   - 角色显示为"企业普通用户"
   - 关联企业自动显示为"测试企业A"

5. **验证用户权限**
   - 退出企业管理员账号
   - 使用 `company_user1` / `123456` 登录
   - 验证可以：
     - ✅ 查看本企业的数据（车辆、运输统计等）
     - ✅ 填写问卷
     - ✅ 提交反馈
     - ❌ 不能访问"企业内部用户"菜单（无用户管理权限）
     - ❌ 不能看到其他企业的数据

#### 预期结果：
- ✅ 企业管理员可以成功创建本企业的普通用户
- ✅ 新用户自动绑定到当前企业
- ✅ 新用户可以登录系统
- ✅ 权限受限正确（只能查看本企业数据，无管理权限）

---

### 3.5 司机用户（DRIVER）注册测试

#### 前置条件：
- 需要先有至少一辆车辆（属于该企业）

#### 测试步骤：

1. **创建车辆（如果还没有）**
   - 使用企业管理员 `company_admin_a` 登录
   - 进入"车辆管理"页面
   - 创建一辆车辆：
     ```
     车牌号：京A12345
     车辆类型：普通
     车辆类别：菜篮子工程车
     车牌颜色：蓝牌
     企业：测试企业A（自动选择）
     ```
   - 保存车辆

2. **创建司机用户**
   - 进入"企业内部用户"页面
   - 点击"新增用户"
   - 填写表单：
     ```
     用户名：driver1
     密码：123456
     昵称：司机1
     邮箱：driver1@test.com
     电话：13800138005
     角色：司机用户
     关联车辆：京A12345 - 测试企业A（必须选择）
     状态：启用
     ```
   - 点击"确定"保存

3. **验证司机用户**
   - 在用户列表中可以看到新创建的司机用户
   - 角色显示为"司机用户"
   - 关联车辆显示为"京A12345"
   - 关联企业自动显示为"测试企业A"（通过车辆获取）

4. **验证司机用户权限**
   - 退出企业管理员账号
   - 使用 `driver1` / `123456` 登录
   - 验证可以：
     - ✅ 查看与自己绑定的车辆信息
     - ✅ 填报该车辆的运输数据
     - ✅ 提交反馈
     - ❌ 不能看到其他车辆的数据
     - ❌ 不能访问企业管理、用户管理等页面

#### 预期结果：
- ✅ 企业管理员可以成功创建司机用户
- ✅ 司机用户必须关联车辆
- ✅ 司机用户自动关联到车辆所属企业
- ✅ 司机用户可以登录系统
- ✅ 权限受限正确（只能查看/操作自己绑定的车辆数据）

---

## 四、完整测试流程示例

### 场景：完整的企业入驻流程

1. **企业自助注册**
   - 访问注册页面 → 填写企业和管理员信息 → 提交
   - ✅ 注册成功，状态为"待审核"

2. **商务委审批**
   - 商务委登录 → 查看待审核企业 → 审批通过
   - ✅ 企业状态变为"已通过"，管理员账号启用

3. **企业管理员登录**
   - 使用企业管理员账号登录
   - ✅ 可以登录，看到本企业相关菜单

4. **创建企业内部用户**
   - 创建普通用户 `company_user1`
   - 创建司机用户 `driver1`（需先有车辆）
   - ✅ 用户创建成功，自动绑定企业

5. **验证各用户权限**
   - 普通用户登录 → 只能看到本企业数据
   - 司机用户登录 → 只能看到自己车辆数据
   - ✅ 权限控制正确

---

## 五、常见问题排查

### 5.1 企业管理员无法登录

**问题**：企业注册后，管理员账号无法登录

**可能原因**：
1. 企业状态仍为 `PENDING`，账号被禁用
2. 商务委尚未审批通过

**解决方法**：
- 使用商务委账号登录，审批通过该企业
- 或使用 ADMIN 账号，在企业管理中手动将企业状态改为 `APPROVED`，并启用对应的管理员账号

### 5.2 创建用户时提示"该角色必须选择关联企业"

**问题**：创建 `COMPANY_USER` 时提示必须选择关联企业

**解决方法**：
- 对于企业管理员：不需要手动选择，系统会自动绑定当前企业
- 对于系统管理员：必须手动选择关联企业

### 5.3 创建司机用户时车辆列表为空

**问题**：创建司机用户时，车辆下拉列表为空

**可能原因**：
1. 当前企业下没有车辆
2. 后端接口权限问题

**解决方法**：
- 先创建至少一辆车辆（属于当前企业）
- 刷新页面，车辆列表应该会显示

### 5.4 密码加密问题

**问题**：登录时提示"用户名或密码错误"，但确认密码正确

**可能原因**：
- 旧数据使用 SHA-256 加密，新数据使用 BCrypt
- 系统会自动兼容，但如果密码哈希格式不正确可能导致问题

**解决方法**：
- 使用 ADMIN 账号重置该用户密码
- 或直接在数据库中更新密码（使用 BCrypt 哈希）

---

## 六、测试检查清单

### 系统管理员（ADMIN）
- [ ] 可以通过数据库创建初始 ADMIN
- [ ] ADMIN 可以登录系统
- [ ] ADMIN 可以创建其他 ADMIN
- [ ] ADMIN 可以创建商务委用户
- [ ] ADMIN 可以创建企业用户和司机用户
- [ ] ADMIN 拥有所有权限

### 商务委用户（BUSINESS_COMMISSION）
- [ ] ADMIN 可以创建商务委用户
- [ ] 商务委用户可以登录系统
- [ ] 商务委可以查看所有企业
- [ ] 商务委可以审批企业注册（通过/驳回）
- [ ] 商务委不能创建/删除企业
- [ ] 商务委不能管理用户

### 企业管理员（COMPANY_ADMIN）
- [ ] 企业可以自助注册
- [ ] 注册后状态为"待审核"
- [ ] 注册后管理员账号被禁用
- [ ] 商务委可以审批通过
- [ ] 审批通过后管理员账号自动启用
- [ ] 企业管理员可以登录
- [ ] 企业管理员只能看到本企业数据
- [ ] 企业管理员可以创建本企业的普通用户和司机用户

### 企业普通用户（COMPANY_USER）
- [ ] 企业管理员可以创建普通用户
- [ ] 普通用户自动绑定企业
- [ ] 普通用户可以登录
- [ ] 普通用户只能看到本企业数据
- [ ] 普通用户无管理权限

### 司机用户（DRIVER）
- [ ] 企业管理员可以创建司机用户
- [ ] 司机用户必须关联车辆
- [ ] 司机用户自动关联企业
- [ ] 司机用户可以登录
- [ ] 司机用户只能看到自己车辆数据
- [ ] 司机用户无管理权限

---

## 七、测试数据示例

### 测试企业列表

| 企业名称 | 管理员账号 | 密码 | 状态 | 用途 |
|---------|-----------|------|------|------|
| 测试企业A | company_admin_a | 123456 | 已通过 | 正常流程测试 |
| 测试企业B | company_admin_b | 123456 | 已驳回 | 驳回流程测试 |
| 测试企业C | company_admin_c | 123456 | 待审核 | 待审批测试 |

### 测试用户列表

| 用户名 | 角色 | 密码 | 关联企业 | 关联车辆 |
|--------|------|------|---------|---------|
| admin | ADMIN | 123123 | - | - |
| business_commission1 | BUSINESS_COMMISSION | 123456 | - | - |
| company_admin_a | COMPANY_ADMIN | 123456 | 测试企业A | - |
| company_user1 | COMPANY_USER | 123456 | 测试企业A | - |
| driver1 | DRIVER | 123456 | 测试企业A | 京A12345 |

---

## 八、API 测试（可选）

如果需要直接通过 API 测试，可以使用 Postman 或 curl：

### 企业自助注册 API

```bash
curl -X POST http://localhost:8080/company-registration/register \
  -H "Content-Type: application/json" \
  -d '{
    "companyName": "API测试企业",
    "address": "测试地址",
    "legalPersonName": "法人",
    "legalPersonPhone": "13800138000",
    "freightPassContactName": "联系人",
    "freightPassContactPhone": "13800138001",
    "companyType": "民营",
    "businessScope": "测试经营范围",
    "adminUsername": "api_test_admin",
    "adminPassword": "123456",
    "adminNickname": "API测试管理员",
    "adminPhone": "13800138002",
    "adminEmail": "api@test.com"
  }'
```

### 商务委审批通过 API

```bash
curl -X POST "http://localhost:8080/company-registration/{companyId}/approve?remark=API测试审批通过" \
  -H "Authorization: Bearer {token}"
```

---

## 九、总结

所有用户注册流程测试完成后，应该能够：

1. ✅ 系统管理员可以创建所有类型的用户
2. ✅ 企业可以自助注册，等待商务委审批
3. ✅ 商务委可以审批企业注册申请
4. ✅ 企业管理员可以管理本企业的用户
5. ✅ 各角色权限控制正确，数据隔离有效

如果测试过程中遇到问题，请参考"常见问题排查"部分，或检查后端日志和前端控制台错误信息。

# 内存优化说明

本文档说明如何在 2GB 内存服务器上运行菜篮子工程车系统。

---

## 📊 内存分配方案

### 标准配置（4GB 内存）

- **MySQL**：约 1-2GB（自动调整）
- **后端 Java**：约 1-2GB（JVM 自动调整）
- **前端 Nginx**：约 50-100MB
- **操作系统**：约 500-600MB
- **Docker 系统**：约 100-200MB
- **总计**：约 3-4GB

### 低内存配置（2GB 内存）

- **MySQL**：512MB（限制 InnoDB 缓冲池为 256MB）
- **后端 Java**：768MB（JVM 堆内存 512MB + 元空间 256MB）
- **前端 Nginx**：128MB
- **操作系统**：约 500-600MB
- **Docker 系统**：约 100MB
- **总计**：约 1.9-2GB

---

## 🔧 优化策略

### 1. MySQL 内存优化

**关键参数**：
- `innodb-buffer-pool-size=256M`：InnoDB 缓冲池，这是 MySQL 最重要的内存参数
- `max-connections=50`：降低最大连接数（默认 151）
- `table-open-cache=512`：降低表缓存（默认 4000）
- `thread-cache-size=8`：降低线程缓存（默认 9）

**效果**：MySQL 内存占用从 1-2GB 降低到约 512MB

### 2. Java 后端内存优化

**JVM 参数**：
```bash
-Xms256m              # 初始堆内存 256MB
-Xmx512m              # 最大堆内存 512MB
-XX:MetaspaceSize=128m        # 元空间初始大小 128MB
-XX:MaxMetaspaceSize=256m     # 元空间最大大小 256MB
-XX:+UseG1GC                  # 使用 G1 垃圾回收器（适合低内存）
-XX:MaxGCPauseMillis=200      # 最大 GC 暂停时间 200ms
-XX:+UseStringDeduplication   # 字符串去重（节省内存）
```

**效果**：后端内存占用从 1-2GB 降低到约 768MB

### 3. Docker 资源限制

使用 Docker Compose 的 `deploy.resources` 限制每个容器的内存使用：

```yaml
deploy:
  resources:
    limits:
      memory: 512M    # 硬限制
    reservations:
      memory: 256M    # 软限制
```

**效果**：防止容器占用过多内存，确保系统稳定运行

---

## 📈 性能影响

### 优点
- ✅ 可以在 2GB 内存服务器上运行
- ✅ 功能完整，不影响业务逻辑
- ✅ 适合学习环境，并发 10 人左右

### 缺点
- ⚠️ 响应速度可能略慢（但可接受）
- ⚠️ 并发处理能力降低（最大连接数 50）
- ⚠️ 不适合高并发生产环境

### 性能对比

| 指标 | 4GB 内存（标准） | 2GB 内存（优化） |
|------|-----------------|-----------------|
| 系统启动时间 | 约 30-60 秒 | 约 60-90 秒 |
| API 响应时间 | 50-200ms | 100-300ms |
| 最大并发用户 | 50+ | 10-20 |
| 数据库查询速度 | 快 | 中等 |
| 内存使用率 | 60-70% | 90-95% |

---

## 🚀 使用方法

### 方法一：使用部署脚本（推荐）

部署脚本会自动检测内存并选择配置：

```bash
bash deploy.sh
```

如果检测到内存小于 3GB，会自动使用 `docker-compose.low-memory.yml`

### 方法二：手动指定配置

```bash
# 使用低内存配置
docker-compose -f docker-compose.low-memory.yml up -d --build
```

---

## 🔍 监控内存使用

### 查看容器内存使用

```bash
# 实时查看所有容器内存使用
docker stats

# 查看特定容器
docker stats cailanzi-mysql cailanzi-backend cailanzi-frontend
```

### 查看系统内存

```bash
# 查看系统内存使用情况
free -h

# 查看详细内存信息
cat /proc/meminfo
```

### 预期内存使用

在 2GB 内存服务器上，正常运行时的内存使用应该如下：

```
总内存: 2048MB
已使用: 约 1900MB
可用:   约 150MB
```

---

## ⚠️ 注意事项

1. **不要同时运行其他大型服务**：2GB 内存已经比较紧张
2. **定期清理日志**：避免日志文件占用过多磁盘空间
3. **监控内存使用**：如果经常出现 OOM（内存溢出），考虑升级内存
4. **数据库连接数**：最大连接数已降低到 50，不要同时打开过多连接
5. **并发用户数**：建议控制在 10 人左右，过多用户可能导致性能下降

---

## 🐛 问题排查

### 问题：容器频繁重启（OOM）

**原因**：内存不足，容器被系统杀死

**解决方法**：
1. 检查是否有其他服务占用内存
2. 进一步降低 MySQL 或 Java 的内存限制
3. 考虑升级到 4GB 内存

### 问题：系统响应慢

**原因**：内存不足，系统频繁使用 swap（交换分区）

**解决方法**：
1. 检查 swap 使用情况：`free -h`
2. 如果 swap 使用率高，说明内存不足
3. 考虑升级内存或减少并发用户数

### 问题：数据库连接失败

**原因**：可能达到最大连接数限制（50）

**解决方法**：
1. 检查当前连接数：`docker exec -it cailanzi-mysql mysql -uroot -p -e "SHOW PROCESSLIST;"`
2. 如果连接数接近 50，需要优化应用代码，减少连接数
3. 可以适当增加 `max-connections`（但会增加内存使用）

---

## 📝 总结

2GB 内存配置适用于：
- ✅ 学习环境
- ✅ 开发测试
- ✅ 小规模使用（并发 10 人左右）

不适合：
- ❌ 生产环境
- ❌ 高并发场景
- ❌ 大数据量处理

**建议**：如果条件允许，优先使用 4GB 内存服务器，以获得更好的性能和稳定性。

---

**相关文档**：
- [详细部署指南](DEPLOYMENT_GUIDE.md)
- [快速参考](DEPLOYMENT_QUICK_REFERENCE.md)

